# テストガイド

レシートスキャナーGPTsの動作確認手順

## テスト環境の確認

### 前提条件
- [ ] Google Spreadsheetが作成されている
- [ ] Apps Scriptがデプロイされている
- [ ] GPTsが作成されている
- [ ] GPTs ActionsのURLが正しく設定されている

---

## Phase 1: Apps Script 単体テスト

### 1-1. テスト関数の実行

1. Apps Scriptエディタを開く
2. 関数選択で `testAddReceipt` を選択
3. 「実行」ボタンをクリック
4. 実行ログを確認:
```
{
  rowNumber: 2,
  timestamp: "2025-10-22T12:34:56.789Z",
  message: "レシートデータを追加しました"
}
```

### 1-2. スプレッドシート確認

1. Google Spreadsheetを開く
2. 「レシート一覧」シートが自動作成されている
3. ヘッダー行 + テストデータ行が存在

**期待される結果:**
| 登録日時 | 購入日 | 店舗名 | カテゴリ | 合計金額 | 消費税 | 支払方法 | 商品明細 | メモ |
|---------|--------|--------|---------|---------|--------|---------|---------|------|
| 2025-10-22 XX:XX | 2025-10-22 | セブンイレブン | 食費 | ¥1,234 | ¥91 | 現金 | [{"name":"おにぎり"...}] | テストデータ |

---

## Phase 2: API エンドポイントテスト

### 2-1. curlでのテスト（任意）

**GETリクエスト（ヘルスチェック）:**
```bash
curl "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec"
```

**期待される応答:**
```json
{
  "statusCode": 200,
  "message": "Receipt Scanner API is running"
}
```

**POSTリクエスト（データ登録）:**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "date": "2025-10-22",
    "store": "ローソン",
    "category": "食費",
    "total": 500,
    "tax": 37,
    "paymentMethod": "電子マネー"
  }' \
  "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec"
```

**期待される応答:**
```json
{
  "statusCode": 200,
  "message": "Success",
  "data": {
    "rowNumber": 3,
    "timestamp": "2025-10-22T12:34:56.789Z",
    "message": "レシートデータを追加しました"
  }
}
```

### 2-2. Apps Scriptログの確認

エラーが発生した場合:
1. Apps Scriptエディタ → 「表示」→「ログ」
2. エラーメッセージを確認
3. 必要に応じてデバッグ

---

## Phase 3: GPTs統合テスト

### 3-1. テストシナリオ1: 基本的な画像アップロード

**手順:**
1. GPTsを開く
2. 簡単なテキストレシート画像をアップロード（手書きメモでもOK）
3. GPTsが内容を読み取る
4. 「登録してください」と入力

**期待される動作:**
- GPTsがレシート内容を抽出して表示
- ユーザー確認後、API呼び出し
- 「✅ スプレッドシートに登録完了しました！」メッセージ
- 行番号が表示される

**確認項目:**
- [ ] 画像がアップロードできる
- [ ] 店舗名が正しく抽出される
- [ ] 金額が正しく抽出される
- [ ] 日付が正しく抽出される
- [ ] APIが正常に呼び出される
- [ ] スプレッドシートに記録される

### 3-2. テストシナリオ2: 商品明細の抽出

**手順:**
1. 商品明細が明確なレシート画像をアップロード
2. 「商品の明細も詳しく抽出してください」と指示
3. 内容を確認して登録

**期待される動作:**
- items配列に複数の商品が含まれる
- 商品名、価格、数量が正しい
- スプレッドシートのH列にJSON形式で記録

**確認項目:**
- [ ] 複数商品が抽出される
- [ ] 商品名が正確
- [ ] 価格と数量が一致
- [ ] JSON形式で記録される

### 3-3. テストシナリオ3: データ修正

**手順:**
1. レシート画像をアップロード
2. GPTsが抽出したデータを確認
3. 「カテゴリを日用品に変更してください」と指示
4. 修正後のデータで登録

**期待される動作:**
- GPTsがデータを修正
- 修正後の内容を再表示
- 正しいデータで登録

**確認項目:**
- [ ] ユーザーの修正指示を理解
- [ ] データが正しく更新される
- [ ] 修正後のデータで登録される

### 3-4. テストシナリオ4: 不鮮明な画像

**手順:**
1. ぼやけた、または暗いレシート画像をアップロード
2. GPTsの応答を確認

**期待される動作:**
- 読み取れない項目について言及
- 手動入力を促す
- 部分的なデータでも登録可能

**確認項目:**
- [ ] 不明な項目を明示
- [ ] 手動入力を促す
- [ ] エラーで止まらない

---

## Phase 4: エラーハンドリングテスト

### 4-1. 不正なデータ送信

**テスト内容:**
Apps ScriptのdoPost関数に不正なJSONを送信

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d 'invalid json' \
  "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec"
```

**期待される応答:**
```json
{
  "statusCode": 500,
  "message": "Internal Server Error: ..."
}
```

### 4-2. 必須項目なしのデータ

**テスト内容:**
店舗名も金額もないデータを送信

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"notes": "テスト"}' \
  "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec"
```

**期待される応答:**
```json
{
  "statusCode": 400,
  "message": "Invalid data format"
}
```

### 4-3. スプレッドシートIDが間違っている場合

**テスト内容:**
Apps Scriptの`SPREADSHEET_ID`を無効なIDに変更して実行

**期待される動作:**
- エラーログに「Exception: Spreadsheet not found」などが記録される
- statusCode 500のエラーレスポンス

---

## Phase 5: パフォーマンステスト

### 5-1. 連続登録テスト

**手順:**
1. GPTsで5枚のレシート画像を連続アップロード
2. それぞれ登録

**確認項目:**
- [ ] すべて正常に登録される
- [ ] スプレッドシートの行番号が連続
- [ ] レスポンスタイムが極端に遅くならない

### 5-2. 大量商品明細テスト

**手順:**
1. 商品が20個以上あるレシート画像をアップロード
2. 全商品を抽出するよう指示

**確認項目:**
- [ ] すべての商品が抽出される
- [ ] JSON文字列長制限に引っかからない
- [ ] スプレッドシートに正常記録

---

## Phase 6: セキュリティテスト

### 6-1. アクセス権限の確認

**テスト内容:**
別のGoogleアカウントでAPIエンドポイントにアクセス

**期待される動作:**
- 「アクセスできるユーザー: 全員」設定なら成功
- スプレッドシート自体は元のアカウントでのみ閲覧可能

### 6-2. SQLインジェクション的な入力

**テスト内容:**
店舗名に特殊文字を含むデータを送信

```json
{
  "store": "'; DROP TABLE--",
  "total": 1000
}
```

**期待される動作:**
- 通常の文字列として処理される
- エラーなく登録される（Apps ScriptはSQLを使用しないため安全）

---

## テストチェックリスト

### 基本機能
- [ ] Apps Script単体で動作する
- [ ] APIエンドポイントが応答する
- [ ] GPTsから画像をアップロードできる
- [ ] データが正しく抽出される
- [ ] スプレッドシートに記録される

### データ品質
- [ ] 店舗名が正確
- [ ] 金額が正確
- [ ] 日付が正しい形式
- [ ] カテゴリ分類が適切
- [ ] 商品明細が詳細

### エラーハンドリング
- [ ] 不正なデータでエラーを返す
- [ ] 不鮮明な画像に対応
- [ ] APIエラー時に適切なメッセージ

### ユーザビリティ
- [ ] 確認プロセスが分かりやすい
- [ ] 修正指示が理解される
- [ ] 登録完了が明確に通知される

### セキュリティ
- [ ] スプレッドシートアクセス権限が適切
- [ ] 個人情報が保護されている
- [ ] 不正な入力で問題が起きない

---

## トラブル時の対処

### GPTsがAPIを呼び出さない

**原因候補:**
1. Actions設定が間違っている
2. デプロイURLが間違っている
3. Actionsが保存されていない

**対処:**
1. GPTsの「Configure」→「Actions」を確認
2. Schema内のURLが正しいか確認
3. 「Save」をクリックして再保存

### スプレッドシートに記録されない

**原因候補:**
1. SPREADSHEET_IDが間違っている
2. シート作成権限がない
3. API呼び出しは成功しているがデータが見えない

**対処:**
1. Apps ScriptのログでSPREADSHEET_IDを確認
2. testAddReceipt関数を実行して権限確認
3. スプレッドシートをリロード

### GPTsが画像を読み取れない

**原因候補:**
1. 画像が不鮮明
2. Vision APIの制限
3. 日本語レシートの認識精度

**対処:**
1. 明るい場所で再撮影
2. レシート全体がフレームに収まるようにする
3. 手動でデータ入力を促す

---

## サンプルデータを使ったテスト

`docs/sample_data.json`にテスト用のサンプルデータがあります。

**curlでのテスト例:**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d @docs/sample_data.json \
  "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec"
```

または、Apps Scriptで:
```javascript
function testWithSampleData() {
  const sampleData = {
    "date": "2025-10-22",
    "store": "セブンイレブン 東京駅前店",
    "category": "食費",
    "total": 1234,
    "tax": 91,
    "paymentMethod": "電子マネー",
    "items": [
      {"name": "おにぎり 梅", "price": 120, "quantity": 2},
      {"name": "サラダチキン", "price": 298, "quantity": 1}
    ],
    "notes": "朝食と昼食分"
  };

  const result = addReceiptToSheet(sampleData);
  Logger.log(result);
}
```

---

以上でテストが完了です。すべてのチェック項目をクリアしたら本番運用を開始できます！
